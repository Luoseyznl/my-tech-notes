#### TCP & UDP

| 特性                | TCP                              | UDP                              |
|---------------------|----------------------------------|----------------------------------|
| **连接性**          | 面向连接（三次握手、四次挥手）   | 无连接，直接发送                |
| **可靠性**          | 可靠（确认、重传、错误检测）     | 不可靠（无确认、无重传）        |
| **传输方式**        | 字节流（无边界）                | 数据报（有边界）                |
| **头部开销**        | 20字节起                        | 8字节                           |
| **速度**            | 较慢（连接管理、拥塞控制）       | 较快（无额外开销）              |
| **流量/拥塞控制**   | 有（滑动窗口、慢启动等）         | 无                              |
| **适用场景**        | 可靠传输（如HTTP、FTP）          | 实时应用（如DNS、流媒体）       |
| **广播/组播**       | 不支持                          | 支持                            |



1. TCP 报文结构（传输控制协议）：面向连接的、可靠的、基于字节流的传输层协议
    ```
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 0
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Source Port          |       Destination Port        | // 端口号
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                        Sequence Number                        | // 序列号
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                    Acknowledgment Number                      | // 确认号
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |  Data |           |U|A|P|R|S|F|                               | // 头部长度
    | Offset| Reserved  |R|C|S|S|Y|I|            Window             | 
    |                   |G|K|H|T|N|N|                               | // 窗口大小
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |           Checksum            |         Urgent Pointer        | // 校验和
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                    Options (if any)                         ... // MSS ...
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    |                            Data                              ...
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    ```
   - Flags
     - URG（紧急指针）ACK（确认号）PSH（推送）RST（重置）SYN（同步序列号）FIN（结束）

   1. 面向连接：三次握手 + 四次挥手
   2. 可靠性：确认机制 + 重传机制 + 错误检测
   3. 按序传输：接收方通过序列号 Seq 重组数据
        ```
        客户端                  服务器
        状态: CLOSED           状态: LISTEN
        |                       |
        |  1. SYN (Seq=x)-----> |  1. 客户端发送SYN，初始化序列号x
        v                       v
        状态: SYN_SENT         状态: SYN_RCVD
        |  2. SYN (Seq=y) <-----|  2. 服务器回复SYN+ACK，初始化序列号y，确认号x+1
        |     ACK (Ack=x+1)     |
        |                       |
        |  3. ACK (Ack=y+1)---> |  3. 客户端确认号y+1，连接建立
        v                       v
        状态: ESTABLISHED      状态: ESTABLISHED
        ```
        ```
        客户端                 服务器
        状态: ESTABLISHED      状态: ESTABLISHED
        |                      |
        |  FIN (Seq=x) ------->|  1. 客户端发送FIN，请求关闭
        v                      v
        状态: FIN_WAIT_1       状态: CLOSE_WAIT
        |  ACK (Ack=x+1) <-----|  2. 服务器确认收到FIN
        v                      v
        状态: FIN_WAIT_2        
        |  FIN (Seq=y) <-------|  3. 服务器发送FIN，关闭其发送方向
        v                      v
        状态: TIME_WAIT        状态: LAST_ACK
        |  ACK (Ack=y+1) ----->|  4. 客户端确认，连接完全关闭
        v                      v
        状态: CLOSED           状态: CLOSED
        ```
   4. 流量控制：动态调整发送速率，避免接收方缓冲区溢出
   5. 拥塞控制：通过算法（如慢启动、拥塞避免）调节网络负载，防止网络拥堵

2. UDP 报文结构（用户数据报协议）：无连接的、不可靠的、基于数据报的传输层协议
    ```
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Source Port          |       Destination Port        | // 源端口号和目的端口号
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |            Length             |           Checksum            | // 报文长度和校验和
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    |                            Data                              ... // 数据部分
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    ```
   1. 无连接、不可靠：无确认机制、重传机制或按序交付
   2. 数据报传输：边界清晰（不像TCP的字节流）
   3. 高效低开销：头部仅8字节，无连接管理和流量控制（应用层需自行控制发送速率）
   4. 支持广播和组播：多播视频流或广播消息

3. 经典问题
   1. 粘包问题：一个大数据包被拆分成多个片段，接收方需重组
      - 原因
        - 字节流特性：TCP不保留消息边界，数据被视为连续字节流
        - Nagle算法：为减少网络开销，TCP将小数据包合并发送，直到积累足够数据或超时
        - 接收方缓冲：接收方可能一次性从缓冲区读取多个发送方的包
        - 网络延迟：数据包在网络中延迟或重排序，导致接收顺序混乱
      - 解决方法
        - 定长消息：每个消息固定长度，接收方按固定字节读取
        - 长度前缀：消息头部包含长度字段，接收方先读取长度再读取数据
        - 分隔符：在消息间添加分隔符（如\n、\0），接收方按分隔符拆分
        - 禁用Nagle算法：强制立即发送小数据包
   2. SYN攻击：占满服务器的半连接队列（SYN_RECV状态）
      - 原因：攻击者伪造IP地址发送SYN，服务器无法收到ACK，资源被占用
      - 解决方法：
        - 增加半连接队列大小、减少SYN_RECV超时、使用iptables或硬件防火墙限制SYN包速率
        - 启用SYN Cookies：服务器收到ACK后再验证连接信息
        - 负载均衡：使用Nginx或云服务（如AWS ELB）分担SYN洪流
   3. 糊涂窗口综合征
      - 原因：TCP发送方或接收方窗口过小，导致频繁传输小数据包
      - 解决方法：Nagle算法：默认启用，合并小数据包

